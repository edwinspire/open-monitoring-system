{"version":3,"file":"Server.js","sourceRoot":"","sources":["../../src/Server.ts"],"names":[],"mappings":"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","sourcesContent":["import keys from './keys';\n\nimport Task from '@dojo/core/async/Task';\nimport request, { RequestOptions } from '@dojo/core/request';\nimport { Response as ResponseInterface } from '@dojo/core/request/interfaces';\nimport { NodeRequestOptions } from '@dojo/core/request/providers/node';\nimport Session from './Session';\nimport Element from './Element';\nimport statusCodes from './lib/statusCodes';\nimport { format, parse, resolve, Url } from 'url';\nimport { sleep, trimStack } from './lib/util';\nimport { create, mixin } from '@dojo/core/lang';\nimport { Capabilities, LeadfootURL, LeadfootError } from './interfaces';\n\nexport default class Server {\n\turl: string;\n\n\trequestOptions: RequestOptions;\n\n\t/**\n\t * An alternative session constructor. Defaults to the standard [[Session]]\n\t * constructor if one is not provided.\n\t */\n\tsessionConstructor = Session;\n\n\t/**\n\t * Whether or not to detect and/or correct environment capabilities when\n\t * creating a new Server. If the value is \"no-detect\", capabilities will be\n\t * updated with already-known features and defects based on the platform, but\n\t * no tests will be run.\n\t */\n\tfixSessionCapabilities: boolean | 'no-detect' = true;\n\n\t/**\n\t * The Server class represents a remote HTTP server implementing the\n\t * WebDriver wire protocol that can be used to generate new remote control\n\t * sessions.\n\t *\n\t * @param url The fully qualified URL to the JsonWireProtocol endpoint on\n\t * the server. The default endpoint for a JsonWireProtocol HTTP server is\n\t * http://localhost:4444/wd/hub. You may also pass a parsed URL object\n\t * which will be converted to a string.\n\t * @param options Additional request options to be used for requests to the\n\t * server.\n\t */\n\t// TODO: NodeRequestOptions doesn't take a type in dojo-core alpha 20\n\tconstructor(url: string | LeadfootURL, options?: NodeRequestOptions) {\n\t\tif (typeof url === 'object') {\n\t\t\turl = <URL>Object.create(url);\n\t\t\tif (url.username || url.password || url.accessKey) {\n\t\t\t\turl.auth =\n\t\t\t\t\tencodeURIComponent(url.username || '') +\n\t\t\t\t\t':' +\n\t\t\t\t\tencodeURIComponent(url.password || url.accessKey || '');\n\t\t\t}\n\t\t}\n\n\t\tthis.url = format(<Url>url).replace(/\\/*$/, '/');\n\t\tthis.requestOptions = options || {};\n\t}\n\n\t/**\n\t * A function that performs an HTTP request to a JsonWireProtocol endpoint\n\t * and normalises response status and data.\n\t *\n\t * @param method The HTTP method to fix\n\t *\n\t * @param path The path-part of the JsonWireProtocol URL. May contain\n\t * placeholders in the form `/\\$\\d/` that will be replaced by entries in\n\t * the `pathParts` argument.\n\t *\n\t * @param requestData The payload for the request.\n\t *\n\t * @param pathParts Optional placeholder values to inject into the path of\n\t * the URL.\n\t */\n\tprivate _sendRequest<T>(\n\t\tmethod: string,\n\t\tpath: string,\n\t\trequestData: any,\n\t\tpathParts?: string[]\n\t): Task<T> {\n\t\tconst url =\n\t\t\tthis.url +\n\t\t\tpath.replace(/\\$(\\d)/, function(_, index) {\n\t\t\t\treturn encodeURIComponent(pathParts![index]);\n\t\t\t});\n\n\t\tconst defaultRequestHeaders: { [key: string]: string } = {\n\t\t\t// At least FirefoxDriver on Selenium 2.40.0 will throw a\n\t\t\t// NullPointerException when retrieving session capabilities if an\n\t\t\t// Accept header is not provided. (It is a good idea to provide one\n\t\t\t// anyway)\n\t\t\tAccept: 'application/json,text/plain;q=0.9'\n\t\t};\n\n\t\tconst kwArgs = create(this.requestOptions, {\n\t\t\tfollowRedirects: false,\n\t\t\thandleAs: 'text',\n\t\t\theaders: { ...defaultRequestHeaders },\n\t\t\tmethod: method\n\t\t});\n\n\t\tif (requestData) {\n\t\t\tkwArgs.body = JSON.stringify(requestData);\n\t\t\tkwArgs.headers['Content-Type'] = 'application/json;charset=UTF-8';\n\t\t\t// At least ChromeDriver 2.9.248307 will not process request data\n\t\t\t// if the length of the data is not provided. (It is a good idea to\n\t\t\t// provide one anyway)\n\t\t\tkwArgs.headers['Content-Length'] = String(\n\t\t\t\tBuffer.byteLength(kwArgs.body, 'utf8')\n\t\t\t);\n\t\t} else {\n\t\t\t// At least Selenium 2.41.0 - 2.42.2 running as a grid hub will\n\t\t\t// throw an exception and drop the current session if a\n\t\t\t// Content-Length header is not provided with a DELETE or POST\n\t\t\t// request, regardless of whether the request actually contains any\n\t\t\t// request data.\n\t\t\tkwArgs.headers['Content-Length'] = '0';\n\t\t}\n\n\t\tconst trace: any = {};\n\t\tError.captureStackTrace(trace, this._sendRequest);\n\n\t\treturn new Task<ResponseInterface>((resolve, reject) => {\n\t\t\trequest(url, kwArgs)\n\t\t\t\t.then(resolve, reject)\n\t\t\t\t.finally(() => {\n\t\t\t\t\tconst error = new Error('Canceled');\n\t\t\t\t\terror.name = 'CancelError';\n\t\t\t\t\treject(error);\n\t\t\t\t});\n\t\t})\n\t\t\t.then(function handleResponse(\n\t\t\t\tresponse: ResponseInterface\n\t\t\t): ResponseData | Task<ResponseData> {\n\t\t\t\t// The JsonWireProtocol specification prior to June 2013 stated\n\t\t\t\t// that creating a new session should perform a 3xx redirect to\n\t\t\t\t// the session capabilities URL, instead of simply returning\n\t\t\t\t// the returning data about the session; as a result, we need\n\t\t\t\t// to follow all redirects to get consistent data\n\t\t\t\tif (\n\t\t\t\t\tresponse.status >= 300 &&\n\t\t\t\t\tresponse.status < 400 &&\n\t\t\t\t\tresponse.headers.get('Location')\n\t\t\t\t) {\n\t\t\t\t\tlet redirectUrl = response.headers.get('Location')!;\n\n\t\t\t\t\t// If redirectUrl isn't an absolute URL, resolve it based\n\t\t\t\t\t// on the orignal URL used to create the session\n\t\t\t\t\tif (!/^\\w+:/.test(redirectUrl)) {\n\t\t\t\t\t\tredirectUrl = resolve(url, redirectUrl);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn request(redirectUrl, {\n\t\t\t\t\t\tmethod: 'GET',\n\t\t\t\t\t\theaders: defaultRequestHeaders\n\t\t\t\t\t}).then(handleResponse);\n\t\t\t\t}\n\n\t\t\t\treturn response.text().then(data => {\n\t\t\t\t\treturn { response, data };\n\t\t\t\t});\n\t\t\t})\n\t\t\t.then((responseData: ResponseData) => {\n\t\t\t\tconst response = responseData.response;\n\t\t\t\tconst responseType = response.headers.get('Content-Type');\n\t\t\t\tlet data: any;\n\n\t\t\t\tif (\n\t\t\t\t\tresponseType &&\n\t\t\t\t\tresponseType.indexOf('application/json') === 0 &&\n\t\t\t\t\tresponseData.data\n\t\t\t\t) {\n\t\t\t\t\tdata = JSON.parse(responseData.data);\n\t\t\t\t}\n\n\t\t\t\t// Some drivers will respond to a DELETE request with 204; in\n\t\t\t\t// this case, we know the operation completed successfully, so\n\t\t\t\t// just create an expected response data structure for a\n\t\t\t\t// successful operation to avoid any special conditions\n\t\t\t\t// elsewhere in the code caused by different HTTP return values\n\t\t\t\tif (response.status === 204) {\n\t\t\t\t\tdata = {\n\t\t\t\t\t\tstatus: 0,\n\t\t\t\t\t\tsessionId: null,\n\t\t\t\t\t\tvalue: null\n\t\t\t\t\t};\n\t\t\t\t} else if (\n\t\t\t\t\tresponse.status >= 400 ||\n\t\t\t\t\t(data && data.status > 0)\n\t\t\t\t) {\n\t\t\t\t\tconst error: any = new Error();\n\n\t\t\t\t\t// \"The client should interpret a 404 Not Found response\n\t\t\t\t\t// from the server as an \"Unknown command\" response. All\n\t\t\t\t\t// other 4xx and 5xx responses from the server that do not\n\t\t\t\t\t// define a status field should be interpreted as \"Unknown\n\t\t\t\t\t// error\" responses.\" -\n\t\t\t\t\t// http://code.google.com/p/selenium/wiki/JsonWireProtocol#Response_Status_Codes\n\t\t\t\t\tif (!data) {\n\t\t\t\t\t\tdata = {\n\t\t\t\t\t\t\tstatus:\n\t\t\t\t\t\t\t\tresponse.status === 404 ||\n\t\t\t\t\t\t\t\tresponse.status === 501\n\t\t\t\t\t\t\t\t\t? 9\n\t\t\t\t\t\t\t\t\t: 13,\n\t\t\t\t\t\t\tvalue: {\n\t\t\t\t\t\t\t\tmessage: responseData.data\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t} else if (!data.value && 'message' in data) {\n\t\t\t\t\t\t// ios-driver 0.6.6-SNAPSHOT April 2014 incorrectly\n\t\t\t\t\t\t// implements the specification: does not return error\n\t\t\t\t\t\t// data on the `value` key, and does not return the\n\t\t\t\t\t\t// correct HTTP status for unknown commands\n\t\t\t\t\t\tdata = {\n\t\t\t\t\t\t\tstatus:\n\t\t\t\t\t\t\t\tresponse.status === 404 ||\n\t\t\t\t\t\t\t\tresponse.status === 501 ||\n\t\t\t\t\t\t\t\tdata.message.indexOf('cannot find command') > -1\n\t\t\t\t\t\t\t\t\t? 9\n\t\t\t\t\t\t\t\t\t: 13,\n\t\t\t\t\t\t\tvalue: data\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\t// At least Appium April 2014 responds with the HTTP status\n\t\t\t\t\t// Not Implemented but a Selenium status UnknownError for\n\t\t\t\t\t// commands that are not implemented; these errors are more\n\t\t\t\t\t// properly represented to end-users using the Selenium\n\t\t\t\t\t// status UnknownCommand, so we make the appropriate\n\t\t\t\t\t// coercion here\n\t\t\t\t\tif (response.status === 501 && data.status === 13) {\n\t\t\t\t\t\tdata.status = 9;\n\t\t\t\t\t}\n\n\t\t\t\t\t// At least BrowserStack in May 2016 responds with HTTP 500\n\t\t\t\t\t// and a message value of \"Invalid Command\" for at least\n\t\t\t\t\t// some unknown commands. These errors are more properly\n\t\t\t\t\t// represented to end-users using the Selenium status\n\t\t\t\t\t// UnknownCommand, so we make the appropriate coercion here\n\t\t\t\t\tif (\n\t\t\t\t\t\tresponse.status === 500 &&\n\t\t\t\t\t\tdata.value &&\n\t\t\t\t\t\tdata.value.message === 'Invalid Command'\n\t\t\t\t\t) {\n\t\t\t\t\t\tdata.status = 9;\n\t\t\t\t\t}\n\n\t\t\t\t\t// At least FirefoxDriver 2.40.0 responds with HTTP status\n\t\t\t\t\t// codes other than Not Implemented and a Selenium status\n\t\t\t\t\t// UnknownError for commands that are not implemented;\n\t\t\t\t\t// however, it provides a reliable indicator that the\n\t\t\t\t\t// operation was unsupported by the type of the exception\n\t\t\t\t\t// that was thrown, so also coerce this back into an\n\t\t\t\t\t// UnknownCommand response for end-user code\n\t\t\t\t\tif (\n\t\t\t\t\t\tdata.status === 13 &&\n\t\t\t\t\t\tdata.value &&\n\t\t\t\t\t\tdata.value.class &&\n\t\t\t\t\t\t(data.value.class.indexOf(\n\t\t\t\t\t\t\t'UnsupportedOperationException'\n\t\t\t\t\t\t) > -1 ||\n\t\t\t\t\t\t\tdata.value.class.indexOf(\n\t\t\t\t\t\t\t\t'UnsupportedCommandException'\n\t\t\t\t\t\t\t) > -1)\n\t\t\t\t\t) {\n\t\t\t\t\t\tdata.status = 9;\n\t\t\t\t\t}\n\n\t\t\t\t\t// At least InternetExplorerDriver 2.41.0 & SafariDriver\n\t\t\t\t\t// 2.41.0 respond with HTTP status codes other than Not\n\t\t\t\t\t// Implemented and a Selenium status UnknownError for\n\t\t\t\t\t// commands that are not implemented; like FirefoxDriver\n\t\t\t\t\t// they provide a reliable indicator of unsupported\n\t\t\t\t\t// commands\n\t\t\t\t\tif (\n\t\t\t\t\t\tresponse.status === 500 &&\n\t\t\t\t\t\tdata.value &&\n\t\t\t\t\t\tdata.value.message &&\n\t\t\t\t\t\t(data.value.message.indexOf('Command not found') > -1 ||\n\t\t\t\t\t\t\tdata.value.message.indexOf('Unknown command') > -1)\n\t\t\t\t\t) {\n\t\t\t\t\t\tdata.status = 9;\n\t\t\t\t\t}\n\n\t\t\t\t\t// At least GhostDriver 1.1.0 incorrectly responds with\n\t\t\t\t\t// HTTP 405 instead of HTTP 501 for unimplemented commands\n\t\t\t\t\tif (\n\t\t\t\t\t\tresponse.status === 405 &&\n\t\t\t\t\t\tdata.value &&\n\t\t\t\t\t\tdata.value.message &&\n\t\t\t\t\t\tdata.value.message.indexOf('Invalid Command Method') >\n\t\t\t\t\t\t\t-1\n\t\t\t\t\t) {\n\t\t\t\t\t\tdata.status = 9;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst statusCode =\n\t\t\t\t\t\tstatusCodes[<keyof typeof statusCodes>data.status];\n\t\t\t\t\tif (statusCode) {\n\t\t\t\t\t\tconst [name, message] = statusCode;\n\t\t\t\t\t\tif (name && message) {\n\t\t\t\t\t\t\terror.name = name;\n\t\t\t\t\t\t\terror.message = message;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.value && data.value.message) {\n\t\t\t\t\t\terror.message = data.value.message;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.value && data.value.screen) {\n\t\t\t\t\t\tdata.value.screen = new Buffer(\n\t\t\t\t\t\t\tdata.value.screen,\n\t\t\t\t\t\t\t'base64'\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\terror.status = data.status;\n\t\t\t\t\terror.detail = data.value;\n\t\t\t\t\terror.request = {\n\t\t\t\t\t\turl: url,\n\t\t\t\t\t\tmethod: method,\n\t\t\t\t\t\tdata: requestData\n\t\t\t\t\t};\n\t\t\t\t\terror.response = response;\n\n\t\t\t\t\tconst sanitizedUrl = (function() {\n\t\t\t\t\t\tconst parsedUrl = parse(url);\n\t\t\t\t\t\tif (parsedUrl.auth) {\n\t\t\t\t\t\t\tparsedUrl.auth = '(redacted)';\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn format(parsedUrl);\n\t\t\t\t\t})();\n\n\t\t\t\t\terror.message =\n\t\t\t\t\t\t'[' +\n\t\t\t\t\t\tmethod +\n\t\t\t\t\t\t' ' +\n\t\t\t\t\t\tsanitizedUrl +\n\t\t\t\t\t\t(requestData\n\t\t\t\t\t\t\t? ' / ' + JSON.stringify(requestData)\n\t\t\t\t\t\t\t: '') +\n\t\t\t\t\t\t'] ' +\n\t\t\t\t\t\terror.message;\n\t\t\t\t\terror.stack = error.message + trimStack(trace.stack);\n\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\n\t\t\t\treturn data;\n\t\t\t})\n\t\t\t.catch(function(error) {\n\t\t\t\terror.stack = error.message + trimStack(trace.stack);\n\t\t\t\tthrow error;\n\t\t\t});\n\t}\n\n\tget<T>(path: string, requestData?: Object, pathParts?: string[]): Task<T> {\n\t\treturn this._sendRequest<T>('GET', path, requestData, pathParts);\n\t}\n\n\tpost<T>(path: string, requestData?: Object, pathParts?: string[]): Task<T> {\n\t\treturn this._sendRequest<T>('POST', path, requestData, pathParts);\n\t}\n\n\tdelete<T>(\n\t\tpath: string,\n\t\trequestData?: Object,\n\t\tpathParts?: string[]\n\t): Task<T> {\n\t\treturn this._sendRequest<T>('DELETE', path, requestData, pathParts);\n\t}\n\n\t/**\n\t * Gets the status of the remote server.\n\t *\n\t * @returns An object containing arbitrary properties describing the status\n\t * of the remote server.\n\t */\n\tgetStatus() {\n\t\treturn this.get('status').then(returnValue);\n\t}\n\n\t/**\n\t * Creates a new remote control session on the remote server.\n\t *\n\t * @param desiredCapabilities A hash map of desired capabilities of the\n\t * remote environment. The server may return an environment that does not\n\t * match all the desired capabilities if one is not available.\n\t *\n\t * @param requiredCapabilities A hash map of required capabilities of the\n\t * remote environment. The server will not return an environment that does\n\t * not match all the required capabilities if one is not available.\n\t */\n\tcreateSession<S extends Session = Session>(\n\t\tdesiredCapabilities: Capabilities,\n\t\trequiredCapabilities?: Capabilities\n\t): Task<S> {\n\t\tlet fixSessionCapabilities = this.fixSessionCapabilities;\n\t\tif (desiredCapabilities.fixSessionCapabilities != null) {\n\t\t\tfixSessionCapabilities = desiredCapabilities.fixSessionCapabilities;\n\n\t\t\t// Dont send `fixSessionCapabilities` to the server\n\t\t\tdesiredCapabilities = { ...desiredCapabilities };\n\t\t\tdesiredCapabilities.fixSessionCapabilities = undefined;\n\t\t}\n\n\t\treturn this.post<any>('session', {\n\t\t\tdesiredCapabilities,\n\t\t\trequiredCapabilities\n\t\t}).then(response => {\n\t\t\tlet responseData: object;\n\t\t\tlet sessionId: string;\n\n\t\t\tif (response.value.sessionId && response.value.capabilities) {\n\t\t\t\t// At least geckodriver 0.16 - 0.19 return the sessionId and\n\t\t\t\t// capabilities as value.sessionId and value.capabilities.\n\t\t\t\tresponseData = response.value.capabilities;\n\t\t\t\tsessionId = response.value.sessionId;\n\t\t\t} else if (response.value.value && response.value.sessionId) {\n\t\t\t\t// At least geckodriver 0.15.0 returns the sessionId and\n\t\t\t\t// capabilities as value.sessionId and value.value.\n\t\t\t\tresponseData = response.value.value;\n\t\t\t\tsessionId = response.value.sessionId;\n\t\t\t} else {\n\t\t\t\t// Selenium and chromedriver return the sessionId as a top\n\t\t\t\t// level property in the response, and the capabilities in a\n\t\t\t\t// 'value' property.\n\t\t\t\tresponseData = response.value;\n\t\t\t\tsessionId = response.sessionId;\n\t\t\t}\n\n\t\t\tconst session = new this.sessionConstructor(\n\t\t\t\tsessionId,\n\t\t\t\tthis,\n\t\t\t\tresponseData\n\t\t\t);\n\n\t\t\tif (fixSessionCapabilities) {\n\t\t\t\treturn this._fillCapabilities(\n\t\t\t\t\t<S>session,\n\t\t\t\t\tfixSessionCapabilities !== 'no-detect'\n\t\t\t\t)\n\t\t\t\t\t.catch(error =>\n\t\t\t\t\t\t// The session was started on the server, but we did\n\t\t\t\t\t\t// not resolve the Task yet. If a failure occurs during\n\t\t\t\t\t\t// capabilities filling, we should quit the session on\n\t\t\t\t\t\t// the server too since the caller will not be aware\n\t\t\t\t\t\t// that it ever got that far and will have no access to\n\t\t\t\t\t\t// the session to quit itself.\n\t\t\t\t\t\tsession.quit().finally(() => {\n\t\t\t\t\t\t\tthrow error;\n\t\t\t\t\t\t})\n\t\t\t\t\t)\n\t\t\t\t\t.then(() => <S>session);\n\t\t\t} else {\n\t\t\t\treturn <S>session;\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Fill in known capabilities/defects and optionally run tests to detect\n\t * more\n\t */\n\tprivate _fillCapabilities<S extends Session>(\n\t\tsession: S,\n\t\tdetectCapabilities = true\n\t): Task<S> {\n\t\tmixin(session.capabilities, this._getKnownCapabilities(session));\n\t\treturn (detectCapabilities\n\t\t\t? this._detectCapabilities(session)\n\t\t\t: Task.resolve(session)\n\t\t).then(() => {\n\t\t\tObject.defineProperty(session.capabilities, '_filled', {\n\t\t\t\tvalue: true,\n\t\t\t\tconfigurable: true\n\t\t\t});\n\t\t\treturn session;\n\t\t});\n\t}\n\n\t/**\n\t * Return capabilities and defects that don't require running tests\n\t */\n\tprivate _getKnownCapabilities(session: Session) {\n\t\tconst capabilities = session.capabilities;\n\t\tconst updates: Capabilities = {};\n\n\t\t// At least geckodriver 0.15.0 only returns platformName (not platform)\n\t\t// and browserVersion (not version) in its capabilities.\n\t\tif (capabilities.platform && !capabilities.platformName) {\n\t\t\tcapabilities.platformName = capabilities.platform;\n\t\t}\n\t\tif (capabilities.version && !capabilities.browserVersion) {\n\t\t\tcapabilities.browserVersion = capabilities.version;\n\t\t}\n\n\t\t// At least SafariDriver 2.41.0 fails to allow stand-alone feature\n\t\t// testing because it does not inject user scripts for URLs that are\n\t\t// not http/https\n\t\tif (isSafari(capabilities) && isMac(capabilities)) {\n\t\t\tmixin(updates, {\n\t\t\t\tnativeEvents: false,\n\t\t\t\trotatable: false,\n\t\t\t\tlocationContextEnabled: false,\n\t\t\t\twebStorageEnabled: false,\n\t\t\t\tapplicationCacheEnabled: false,\n\t\t\t\tsupportsNavigationDataUris: true,\n\t\t\t\tsupportsCssTransforms: true,\n\t\t\t\tsupportsExecuteAsync: true,\n\t\t\t\tmouseEnabled: true,\n\t\t\t\ttouchEnabled: false,\n\t\t\t\tdynamicViewport: true,\n\t\t\t\tshortcutKey: keys.COMMAND,\n\n\t\t\t\t// This must be set; running it as a server test will cause\n\t\t\t\t// SafariDriver to emit errors with the text \"undefined is not\n\t\t\t\t// an object (evaluating 'a.postMessage')\", and the session\n\t\t\t\t// will become unresponsive\n\t\t\t\treturnsFromClickImmediately: false,\n\n\t\t\t\tbrokenDeleteCookie: false,\n\t\t\t\tbrokenExecuteElementReturn: false,\n\t\t\t\tbrokenExecuteUndefinedReturn: false,\n\t\t\t\tbrokenElementDisplayedOpacity: false,\n\t\t\t\tbrokenElementDisplayedOffscreen: false,\n\t\t\t\tbrokenSubmitElement: true,\n\t\t\t\tbrokenWindowSwitch: true,\n\t\t\t\tbrokenDoubleClick: false,\n\t\t\t\tbrokenCssTransformedSize: true,\n\t\t\t\tfixedLogTypes: false as false,\n\t\t\t\tbrokenHtmlTagName: false,\n\t\t\t\tbrokenNullGetSpecAttribute: false\n\t\t\t});\n\n\t\t\t// SafariDriver, which shows versions up to 10.x, doesn't support\n\t\t\t// file uploads\n\t\t\tif (isValidVersion(capabilities, 0, 100)) {\n\t\t\t\tmixin(updates, {\n\t\t\t\t\tremoteFiles: false,\n\n\t\t\t\t\tbrokenActiveElement: true,\n\t\t\t\t\tbrokenExecuteForNonHttpUrl: true,\n\t\t\t\t\tbrokenMouseEvents: true,\n\t\t\t\t\tbrokenNavigation: true,\n\t\t\t\t\tbrokenOptionSelect: false,\n\t\t\t\t\tbrokenSendKeys: true,\n\t\t\t\t\tbrokenWindowPosition: true,\n\t\t\t\t\tbrokenWindowSize: true,\n\n\t\t\t\t\t// SafariDriver 2.41.0 cannot delete cookies, at all, ever\n\t\t\t\t\tbrokenCookies: true\n\t\t\t\t});\n\n\t\t\t\tif (isValidVersion(capabilities, 10, 11)) {\n\t\t\t\t\tmixin(updates, {\n\t\t\t\t\t\t// Safari 10 using SafariDriver does not appear to\n\t\t\t\t\t\t// support executeAsync at least as of May 2017\n\t\t\t\t\t\tsupportsExecuteAsync: false\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// The native safaridriver reports versions like '12603.1.30.0.34'\n\t\t\tif (isValidVersion(capabilities, 1000)) {\n\t\t\t\tmixin(updates, {\n\t\t\t\t\tbrokenLinkTextLocator: true,\n\t\t\t\t\tbrokenOptionSelect: true,\n\t\t\t\t\tbrokenWhitespaceNormalization: true,\n\t\t\t\t\tfixedLogTypes: [],\n\t\t\t\t\tusesWebDriverActiveElement: true\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn updates;\n\t\t}\n\n\t\t// The window sizing commands in the W3C standard don't use window\n\t\t// handles, but they do under the JsonWireProtocol. By default, Session\n\t\t// assumes handles are used. When the result of this check is added to\n\t\t// capabilities, Session will take it into account.\n\t\tif (isFirefox(capabilities, 53, Infinity)) {\n\t\t\tupdates.usesWebDriverWindowCommands = true;\n\t\t}\n\n\t\tif (isMsEdge(capabilities)) {\n\t\t\t// At least MS Edge 14316 returns immediately from a click request\n\t\t\t// immediately rather than waiting for default action to occur.\n\t\t\tupdates.returnsFromClickImmediately = true;\n\n\t\t\t// MS Edge has broken cookie deletion.\n\t\t\tupdates.brokenDeleteCookie = true;\n\n\t\t\t// At least MS Edge may return an 'element is obscured' error when\n\t\t\t// trying to click on visible elements.\n\t\t\tupdates.brokenClick = true;\n\n\t\t\t// File uploads don't work on Edge as of May 2017\n\t\t\tupdates.remoteFiles = false;\n\t\t}\n\n\t\t// At least MS Edge 10586 becomes unresponsive after calling DELETE\n\t\t// window, and window.close() requires user interaction. This\n\t\t// capability is distinct from brokenDeleteWindow as this capability\n\t\t// indicates that there is no way to close a Window.\n\t\tif (isMsEdge(capabilities, 25.10586)) {\n\t\t\tupdates.brokenWindowClose = true;\n\t\t}\n\n\t\t// At least MS Edge Driver 14316 doesn't support sending keys to a file\n\t\t// input. See\n\t\t// https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/7194303/\n\t\t//\n\t\t// The existing feature test for this caused some browsers to hang, so\n\t\t// just flag it for Edge for now.\n\t\tif (isMsEdge(capabilities, 38.14366)) {\n\t\t\tupdates.brokenFileSendKeys = true;\n\t\t}\n\n\t\t// At least MS Edge 14316 supports alerts but does not specify the\n\t\t// capability\n\t\tif (\n\t\t\tisMsEdge(capabilities, 37.14316) &&\n\t\t\t!('handlesAlerts' in capabilities)\n\t\t) {\n\t\t\tupdates.handlesAlerts = true;\n\t\t}\n\n\t\tif (isFirefox(capabilities, 49, Infinity)) {\n\t\t\t// The W3C WebDriver standard does not support the session-level\n\t\t\t// /keys command, but JsonWireProtocol does.\n\t\t\tupdates.supportsKeysCommand = false;\n\n\t\t\t// Firefox 49+ (via geckodriver) only supports W3C locator\n\t\t\t// strategies\n\t\t\tupdates.usesWebDriverLocators = true;\n\n\t\t\t// Firefox 49+ (via geckodriver) requires keys sent to an element\n\t\t\t// to be a flat array\n\t\t\tupdates.usesFlatKeysArray = true;\n\n\t\t\t// At least Firefox 49 + geckodriver can't POST empty data\n\t\t\tupdates.brokenEmptyPost = true;\n\n\t\t\t// At least geckodriver 0.11 and Firefox 49 don't implement mouse\n\t\t\t// control, so everything will need to be simulated.\n\t\t\tupdates.brokenMouseEvents = true;\n\n\t\t\t// Firefox 49+ (via geckodriver) doesn't support retrieving logs or\n\t\t\t// log types, and may hang the session.\n\t\t\tupdates.fixedLogTypes = [];\n\t\t}\n\n\t\tif (isFirefox(capabilities, 49, 53)) {\n\t\t\t// At least geckodriver 0.15.0 and Firefox 51 will stop responding\n\t\t\t// to commands when performing window switches.\n\t\t\tupdates.brokenWindowSwitch = true;\n\t\t}\n\n\t\tif (isInternetExplorer(capabilities, 11)) {\n\t\t\t// IE11 will take screenshots, but it's very slow\n\t\t\tupdates.takesScreenshot = true;\n\n\t\t\t// IE11 will hang during this check if nativeEvents are enabled\n\t\t\tupdates.brokenSubmitElement = true;\n\t\t}\n\n\t\tif (isInternetExplorer(capabilities, 11, Infinity)) {\n\t\t\t// At least IE11 will hang during this check, although option\n\t\t\t// selection does work with it\n\t\t\tupdates.brokenOptionSelect = false;\n\t\t}\n\n\t\t// Using mouse services such as doubleclick will hang Firefox 49+\n\t\t// session on the Mac.\n\t\tif (\n\t\t\t!('mouseEnabled' in capabilities) &&\n\t\t\tisFirefox(capabilities, 49, Infinity) &&\n\t\t\tisMac(capabilities)\n\t\t) {\n\t\t\tupdates.mouseEnabled = true;\n\t\t}\n\n\t\t// Don't check for touch support if the environment reports that no\n\t\t// touchscreen is available\n\t\tif (capabilities.hasTouchScreen === false) {\n\t\t\tupdates.touchEnabled = false;\n\t\t}\n\n\t\t// Don't check for touch support if the environment reports that no\n\t\t// touchscreen is available. Also, ChromeDriver\n\t\t// 2.19 claims that it supports touch but it does not implement all of\n\t\t//   the touch endpoints from JsonWireProtocol\n\t\tif (\n\t\t\tcapabilities.hasTouchScreen === false ||\n\t\t\tcapabilities.browserName === 'chrome'\n\t\t) {\n\t\t\tupdates.touchEnabled = false;\n\t\t}\n\n\t\t// It is not possible to test this since the feature tests runs in\n\t\t// quirks-mode on IE<10, but we know that IE9 supports CSS transforms\n\t\tif (isInternetExplorer(capabilities, 9)) {\n\t\t\tupdates.supportsCssTransforms = true;\n\t\t}\n\n\t\tupdates.shortcutKey = (function() {\n\t\t\tconst platform = (capabilities.platform ||\n\t\t\t\tcapabilities.platformName)!;\n\n\t\t\tif (/^mac/i.test(platform) || /^darwin/i.test(platform)) {\n\t\t\t\treturn keys.COMMAND;\n\t\t\t}\n\n\t\t\tif (/^ios/i.test(platform)) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\treturn keys.CONTROL;\n\t\t})();\n\n\t\t// Internet Explorer 8 and earlier will simply crash the server if we\n\t\t// attempt to return the parent frame via script, so never even attempt\n\t\t// to do so\n\t\tupdates.scriptedParentFrameCrashesBrowser = isInternetExplorer(\n\t\t\tcapabilities,\n\t\t\t0,\n\t\t\t9\n\t\t);\n\n\t\tif (\n\t\t\t// At least ios-driver 0.6.6-SNAPSHOT April 2014 corrupts its\n\t\t\t// internal state when performing window switches and gets\n\t\t\t// permanently stuck; we cannot feature detect, so platform\n\t\t\t// sniffing it is\n\t\t\tcapabilities.browserName === 'Safari' &&\n\t\t\tcapabilities.platformName === 'IOS'\n\t\t) {\n\t\t\tupdates.brokenWindowSwitch = true;\n\t\t}\n\n\t\t// At least selendroid 0.12.0-SNAPSHOT doesn't support switching to the\n\t\t// parent frame\n\t\tif (\n\t\t\tcapabilities.browserName === 'android' &&\n\t\t\tcapabilities.deviceName === 'Android Emulator'\n\t\t) {\n\t\t\tupdates.brokenParentFrameSwitch = true;\n\t\t}\n\n\t\treturn updates;\n\t}\n\n\t/**\n\t * Run tests to detect capabilities/defects\n\t */\n\tprivate _detectCapabilities(session: Session): Task<void | Session> {\n\t\tconst capabilities = session.capabilities;\n\t\tconst supported = () => true;\n\t\tconst unsupported = () => false;\n\t\tconst maybeSupported = (error: Error) => {\n\t\t\tif (error.name === 'UnknownCommand') {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (/\\bunimplemented command\\b/.test(error.message)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t};\n\t\tconst broken = supported;\n\t\tconst works = unsupported;\n\n\t\t/**\n\t\t * Adds the capabilities listed in the `testedCapabilities` object to\n\t\t * the hash of capabilities for the current session. If a tested\n\t\t * capability value is a function, it is assumed that it still needs to\n\t\t * be executed serially in order to resolve the correct value of that\n\t\t * particular capability.\n\t\t */\n\t\tconst addCapabilities = (\n\t\t\ttestedCapabilities: Capabilities\n\t\t): Task<void> => {\n\t\t\treturn Object.keys(testedCapabilities).reduce(\n\t\t\t\t(previous: Task<void>, key: keyof Capabilities) => {\n\t\t\t\t\treturn previous.then(() => {\n\t\t\t\t\t\tconst value = testedCapabilities[key];\n\t\t\t\t\t\tconst task =\n\t\t\t\t\t\t\ttypeof value === 'function'\n\t\t\t\t\t\t\t\t? value()\n\t\t\t\t\t\t\t\t: Task.resolve(value);\n\t\t\t\t\t\treturn task.then((value: any) => {\n\t\t\t\t\t\t\tcapabilities[key] = value;\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tTask.resolve()\n\t\t\t);\n\t\t};\n\n\t\tconst get = (page: string) => {\n\t\t\tif (capabilities.supportsNavigationDataUris !== false) {\n\t\t\t\treturn session.get(\n\t\t\t\t\t'data:text/html;charset=utf-8,' + encodeURIComponent(page)\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Internet Explorer 9 and earlier, and Microsoft Edge build 10240\n\t\t\t// and earlier, hang when attempting to do navigate after a\n\t\t\t// `document.write` is performed to reset the tab content; we can\n\t\t\t// still do some limited testing in these browsers by using the\n\t\t\t// initial browser URL page and injecting some content through\n\t\t\t// innerHTML, though it is unfortunately a quirks-mode file so\n\t\t\t// testing is limited\n\t\t\tif (\n\t\t\t\tisInternetExplorer(capabilities, 0, 10) ||\n\t\t\t\tisMsEdge(capabilities)\n\t\t\t) {\n\t\t\t\t// Edge driver doesn't provide an initialBrowserUrl\n\t\t\t\tlet initialUrl = 'about:blank';\n\n\t\t\t\t// As of version 3.3.0.1, IEDriverServer provides IE-specific\n\t\t\t\t// options, including the initialBrowserUrl, under an\n\t\t\t\t// 'se:ieOptions' property rather than directly on\n\t\t\t\t// capabilities.\n\t\t\t\t// https://github.com/SeleniumHQ/selenium/blob/e60b607a97b9b7588d59e0c26ef9a6d1d1350911/cpp/iedriverserver/CHANGELOG\n\t\t\t\tif (\n\t\t\t\t\tisInternetExplorer(capabilities) &&\n\t\t\t\t\tcapabilities['se:ieOptions']\n\t\t\t\t) {\n\t\t\t\t\tinitialUrl = capabilities['se:ieOptions'].initialBrowserUrl;\n\t\t\t\t} else if (capabilities.initialBrowserUrl) {\n\t\t\t\t\tinitialUrl = capabilities.initialBrowserUrl;\n\t\t\t\t}\n\n\t\t\t\treturn session.get(initialUrl).then(function() {\n\t\t\t\t\treturn session.execute<void>(\n\t\t\t\t\t\t'document.body.innerHTML = arguments[0];',\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\t// The DOCTYPE does not apply, for obvious reasons, but\n\t\t\t\t\t\t\t// also old IE will discard invisible elements like\n\t\t\t\t\t\t\t// `<script>` and `<style>` if they are the first\n\t\t\t\t\t\t\t// elements injected with `innerHTML`, so an extra text\n\t\t\t\t\t\t\t// node is added before the rest of the content instead\n\t\t\t\t\t\t\tpage.replace('<!DOCTYPE html>', 'x')\n\t\t\t\t\t\t]\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn session.get('about:blank').then(function() {\n\t\t\t\treturn session.execute<void>('document.write(arguments[0]);', [\n\t\t\t\t\tpage\n\t\t\t\t]);\n\t\t\t});\n\t\t};\n\n\t\tconst discoverServerFeatures = () => {\n\t\t\tconst testedCapabilities: any = {};\n\n\t\t\t// Check that the remote server will accept file uploads. There is\n\t\t\t// a secondary test in discoverDefects that checks whether the\n\t\t\t// server allows typing into file inputs.\n\t\t\tif (capabilities.remoteFiles == null) {\n\t\t\t\ttestedCapabilities.remoteFiles = function() {\n\t\t\t\t\t// TODO: _post probably shouldn't be private\n\t\t\t\t\treturn session\n\t\t\t\t\t\t.serverPost<string>('file', {\n\t\t\t\t\t\t\tfile:\n\t\t\t\t\t\t\t\t'UEsDBAoAAAAAAD0etkYAAAAAAAAAAAAAAAAIABwAdGVzdC50eHRVVAkAA2WnXlVlp15VdXgLAAEE8gMAAATyAwAAUEsBAh4DCgAAAAAAPR62RgAAAAAAAAAAAAAAAAgAGAAAAAAAAAAAAKSBAAAAAHRlc3QudHh0VVQFAANlp15VdXgLAAEE8gMAAATyAwAAUEsFBgAAAAABAAEATgAAAEIAAAAAAA=='\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(filename) {\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\tfilename && filename.indexOf('test.txt') > -1\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(unsupported);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (capabilities.supportsSessionCommand == null) {\n\t\t\t\ttestedCapabilities.supportsSessionCommands = this.get(\n\t\t\t\t\t'session/$0',\n\t\t\t\t\tundefined,\n\t\t\t\t\t[session.sessionId]\n\t\t\t\t).then(supported, unsupported);\n\t\t\t}\n\n\t\t\tif (capabilities.usesWebDriverTimeouts == null) {\n\t\t\t\ttestedCapabilities.usesWebDriverTimeouts = session\n\t\t\t\t\t.setFindTimeout(500)\n\t\t\t\t\t.then(unsupported, error =>\n\t\t\t\t\t\t/Missing 'type' parameter/.test(error.message)\n\t\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (capabilities.usesWebDriverWindowCommands == null) {\n\t\t\t\ttestedCapabilities.usesWebDriverWindowCommands = session\n\t\t\t\t\t.serverGet('window/rect')\n\t\t\t\t\t.then(supported, unsupported);\n\t\t\t}\n\n\t\t\t// The W3C standard says window commands should take a 'handle'\n\t\t\t// parameter, while the JsonWireProtocol used a 'name' parameter.\n\t\t\tif (capabilities.usesHandleParameter == null) {\n\t\t\t\ttestedCapabilities.usesHandleParameter = session\n\t\t\t\t\t.switchToWindow('current')\n\t\t\t\t\t.then(unsupported, error =>\n\t\t\t\t\t\t/Missing .*handle/.test(error.message)\n\t\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Sauce Labs will not return a list of sessions at least as of May\n\t\t\t// 2017\n\t\t\tif (capabilities.brokenSessionList == null) {\n\t\t\t\ttestedCapabilities.brokenSessionList = this.getSessions().then(\n\t\t\t\t\tworks,\n\t\t\t\t\tbroken\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (capabilities.usesWebDriverFrameId == null) {\n\t\t\t\ttestedCapabilities.usesWebDriverFrameId = session\n\t\t\t\t\t.switchToFrame('inlineFrame')\n\t\t\t\t\t.then(unsupported, error =>\n\t\t\t\t\t\t/frame id has unexpected type/.test(error.message)\n\t\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (capabilities.returnsFromClickImmediately == null) {\n\t\t\t\ttestedCapabilities.returnsFromClickImmediately = function() {\n\t\t\t\t\tfunction assertSelected(expected: any) {\n\t\t\t\t\t\treturn function(actual: any) {\n\t\t\t\t\t\t\tif (expected !== actual) {\n\t\t\t\t\t\t\t\tthrow new Error('unexpected selection state');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn get('<!DOCTYPE html><input type=\"checkbox\" id=\"c\">')\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.findById('c');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\treturn element\n\t\t\t\t\t\t\t\t.click()\n\t\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\t\treturn element.isSelected();\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(assertSelected(true))\n\t\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\t\treturn element.click().then(function() {\n\t\t\t\t\t\t\t\t\t\treturn element.isSelected();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(assertSelected(false))\n\t\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\t\treturn element.click().then(function() {\n\t\t\t\t\t\t\t\t\t\treturn element.isSelected();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(assertSelected(true));\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(works, broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// The W3C WebDriver standard does not support the session-level\n\t\t\t// /keys command, but JsonWireProtocol does.\n\t\t\tif (capabilities.supportsKeysCommand == null) {\n\t\t\t\ttestedCapabilities.supportsKeysCommand = session\n\t\t\t\t\t.serverPost('keys', { value: ['a'] })\n\t\t\t\t\t.then(supported, unsupported);\n\t\t\t}\n\n\t\t\treturn Task.all(\n\t\t\t\tObject.keys(testedCapabilities).map(\n\t\t\t\t\tkey => testedCapabilities[key]\n\t\t\t\t)\n\t\t\t).then(() => testedCapabilities);\n\t\t};\n\n\t\tconst discoverFeatures = () => {\n\t\t\tconst testedCapabilities: any = {};\n\n\t\t\t// At least SafariDriver 2.41.0 fails to allow stand-alone feature\n\t\t\t// testing because it does not inject user scripts for URLs that\n\t\t\t// are not http/https\n\t\t\tif (isSafari(capabilities) && isMac(capabilities)) {\n\t\t\t\treturn Task.resolve({});\n\t\t\t}\n\n\t\t\t// Appium iOS as of April 2014 supports rotation but does not\n\t\t\t// specify the capability\n\t\t\tif (capabilities.rotatable == null) {\n\t\t\t\ttestedCapabilities.rotatable = session\n\t\t\t\t\t.getOrientation()\n\t\t\t\t\t.then(supported, unsupported);\n\t\t\t}\n\n\t\t\tif (capabilities.locationContextEnabled) {\n\t\t\t\ttestedCapabilities.locationContextEnabled = session\n\t\t\t\t\t.getGeolocation()\n\t\t\t\t\t.then(supported, function(error) {\n\t\t\t\t\t\t// At least FirefoxDriver 2.40.0 and ios-driver 0.6.0\n\t\t\t\t\t\t// claim they support geolocation in their returned\n\t\t\t\t\t\t// capabilities map, when they do not\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\terror.message.indexOf(\n\t\t\t\t\t\t\t\t'not mapped : GET_LOCATION'\n\t\t\t\t\t\t\t) !== -1\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// At least chromedriver 2.25 requires the location to\n\t\t\t\t\t\t// be set first. At least chromedriver 2.25 will throw\n\t\t\t\t\t\t// a CastClassException while trying to retrieve a\n\t\t\t\t\t\t// geolocation.\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\terror.message.indexOf('Location must be set') !== -1\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\treturn session\n\t\t\t\t\t\t\t\t.setGeolocation({\n\t\t\t\t\t\t\t\t\tlatitude: 12.1,\n\t\t\t\t\t\t\t\t\tlongitude: -22.33,\n\t\t\t\t\t\t\t\t\taltitude: 1000.2\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(() => session.getGeolocation())\n\t\t\t\t\t\t\t\t.then(supported, unsupported);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\t// At least FirefoxDriver 2.40.0 claims it supports web storage in\n\t\t\t// the returned capabilities map, when it does not\n\t\t\tif (capabilities.webStorageEnabled) {\n\t\t\t\ttestedCapabilities.webStorageEnabled = session\n\t\t\t\t\t.getLocalStorageLength()\n\t\t\t\t\t.then(supported, maybeSupported);\n\t\t\t}\n\n\t\t\t// At least FirefoxDriver 2.40.0 claims it supports application\n\t\t\t// cache in the returned capabilities map, when it does not\n\t\t\tif (capabilities.applicationCacheEnabled) {\n\t\t\t\ttestedCapabilities.applicationCacheEnabled = session\n\t\t\t\t\t.getApplicationCacheStatus()\n\t\t\t\t\t.then(supported, maybeSupported);\n\t\t\t}\n\n\t\t\tif (capabilities.takesScreenshot == null) {\n\t\t\t\t// At least Selendroid 0.9.0 will fail to take screenshots in\n\t\t\t\t// certain device configurations, usually emulators with\n\t\t\t\t// hardware acceleration enabled\n\t\t\t\ttestedCapabilities.takesScreenshot = session\n\t\t\t\t\t.takeScreenshot()\n\t\t\t\t\t.then(supported, unsupported);\n\t\t\t}\n\n\t\t\t// At least ios-driver 0.6.6-SNAPSHOT April 2014 does not support\n\t\t\t// execute_async\n\t\t\tif (capabilities.supportsExecuteAsync == null) {\n\t\t\t\ttestedCapabilities.supportsExecuteAsync = session\n\t\t\t\t\t.executeAsync('arguments[0](true);')\n\t\t\t\t\t.catch(unsupported);\n\t\t\t}\n\n\t\t\t// Using mouse services such as doubleclick will hang Firefox 49+\n\t\t\t// session on the Mac.\n\t\t\tif (\n\t\t\t\tcapabilities.mouseEnabled == null &&\n\t\t\t\t!(isFirefox(capabilities, 49, Infinity) && isMac(capabilities))\n\t\t\t) {\n\t\t\t\ttestedCapabilities.mouseEnabled = function() {\n\t\t\t\t\treturn session\n\t\t\t\t\t\t.doubleClick()\n\t\t\t\t\t\t.then(supported, maybeSupported);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (capabilities.touchEnabled == null) {\n\t\t\t\ttestedCapabilities.touchEnabled = function() {\n\t\t\t\t\treturn get(\n\t\t\t\t\t\t'<!DOCTYPE html><button id=\"clicker\">Click me</button>'\n\t\t\t\t\t)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.findById('clicker');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(button) {\n\t\t\t\t\t\t\treturn session\n\t\t\t\t\t\t\t\t.doubleTap(button)\n\t\t\t\t\t\t\t\t.then(supported, maybeSupported);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(unsupported);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (capabilities.dynamicViewport == null) {\n\t\t\t\ttestedCapabilities.dynamicViewport = session\n\t\t\t\t\t.getWindowSize()\n\t\t\t\t\t.then(function(originalSize) {\n\t\t\t\t\t\t// At least Firefox 53 will hang if the target size is\n\t\t\t\t\t\t// the same as the current size\n\t\t\t\t\t\treturn session.setWindowSize(\n\t\t\t\t\t\t\toriginalSize.width - 2,\n\t\t\t\t\t\t\toriginalSize.height - 2\n\t\t\t\t\t\t);\n\t\t\t\t\t})\n\t\t\t\t\t.then(supported, unsupported);\n\t\t\t}\n\n\t\t\t// At least Internet Explorer 11 and earlier do not allow data URIs\n\t\t\t// to be used for navigation\n\t\t\tif (capabilities.supportsNavigationDataUris == null) {\n\t\t\t\ttestedCapabilities.supportsNavigationDataUris = function() {\n\t\t\t\t\treturn get('<!DOCTYPE html><title>a</title>')\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.getPageTitle();\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(pageTitle) {\n\t\t\t\t\t\t\treturn pageTitle === 'a';\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(unsupported);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (capabilities.supportsCssTransforms == null) {\n\t\t\t\ttestedCapabilities.supportsCssTransforms = function() {\n\t\t\t\t\treturn get(\n\t\t\t\t\t\t'<!DOCTYPE html><style>#a{width:8px;height:8px;-ms-transform:scale(0.5);-moz-transform:scale(0.5);-webkit-transform:scale(0.5);transform:scale(0.5);}</style><div id=\"a\"></div>'\n\t\t\t\t\t)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.execute(\n\t\t\t\t\t\t\t\t/* istanbul ignore next */ function() {\n\t\t\t\t\t\t\t\t\tconst bbox = document\n\t\t\t\t\t\t\t\t\t\t.getElementById('a')!\n\t\t\t\t\t\t\t\t\t\t.getBoundingClientRect();\n\t\t\t\t\t\t\t\t\treturn bbox.right - bbox.left === 4;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(unsupported);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn Task.all(\n\t\t\t\tObject.keys(testedCapabilities).map(\n\t\t\t\t\tkey => testedCapabilities[key]\n\t\t\t\t)\n\t\t\t).then(() => testedCapabilities);\n\t\t};\n\n\t\tconst discoverDefects = (): Task<Capabilities> => {\n\t\t\tconst testedCapabilities: any = {};\n\n\t\t\t// At least SafariDriver 2.41.0 fails to allow stand-alone feature\n\t\t\t// testing because it does not inject user scripts for URLs that\n\t\t\t// are not http/https\n\t\t\tif (isSafari(capabilities) && isMac(capabilities)) {\n\t\t\t\treturn Task.resolve({});\n\t\t\t}\n\n\t\t\t// At least ChromeDriver 2.9 and MS Edge 10240 does not implement\n\t\t\t// /element/active\n\t\t\tif (capabilities.brokenActiveElement == null) {\n\t\t\t\ttestedCapabilities.brokenActiveElement = session\n\t\t\t\t\t.getActiveElement()\n\t\t\t\t\t.then(works, function(error) {\n\t\t\t\t\t\treturn error.name === 'UnknownCommand';\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\t// At least Selendroid 0.9.0 has broken cookie deletion.\n\t\t\tif (\n\t\t\t\tcapabilities.brokenDeleteCookie == null &&\n\t\t\t\tcapabilities.browserName === 'selendroid'\n\t\t\t) {\n\t\t\t\t// This test is very hard to get working properly in other\n\t\t\t\t// environments so only test when Selendroid is the browser\n\t\t\t\ttestedCapabilities.brokenDeleteCookie = function() {\n\t\t\t\t\treturn session\n\t\t\t\t\t\t.get('about:blank')\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.clearCookies();\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.setCookie({\n\t\t\t\t\t\t\t\tname: 'foo',\n\t\t\t\t\t\t\t\tvalue: 'foo'\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.deleteCookie('foo');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.getCookies();\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(cookies) {\n\t\t\t\t\t\t\treturn cookies.length > 0;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(function() {\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(isBroken) {\n\t\t\t\t\t\t\treturn session\n\t\t\t\t\t\t\t\t.clearCookies()\n\t\t\t\t\t\t\t\t.then(() => isBroken, () => isBroken);\n\t\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// At least Selendroid 0.9.0 incorrectly returns HTML tag names in\n\t\t\t// uppercase, which is a violation of the JsonWireProtocol spec\n\t\t\tif (capabilities.brokenHtmlTagName == null) {\n\t\t\t\ttestedCapabilities.brokenHtmlTagName = session\n\t\t\t\t\t.findByTagName('html')\n\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\treturn element.getTagName();\n\t\t\t\t\t})\n\t\t\t\t\t.then(function(tagName) {\n\t\t\t\t\t\treturn tagName !== 'html';\n\t\t\t\t\t})\n\t\t\t\t\t.catch(broken);\n\t\t\t}\n\n\t\t\t// At least ios-driver 0.6.6-SNAPSHOT incorrectly returns empty\n\t\t\t// string instead of null for attributes that do not exist\n\t\t\tif (capabilities.brokenNullGetSpecAttribute == null) {\n\t\t\t\ttestedCapabilities.brokenNullGetSpecAttribute = session\n\t\t\t\t\t.findByTagName('html')\n\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\treturn element.getSpecAttribute('nonexisting');\n\t\t\t\t\t})\n\t\t\t\t\t.then(function(value) {\n\t\t\t\t\t\treturn value !== null;\n\t\t\t\t\t})\n\t\t\t\t\t.catch(broken);\n\t\t\t}\n\n\t\t\t// At least MS Edge 10240 doesn't properly deserialize web elements\n\t\t\t// passed as `execute` arguments\n\t\t\tif (capabilities.brokenElementSerialization == null) {\n\t\t\t\ttestedCapabilities.brokenElementSerialization = function() {\n\t\t\t\t\treturn get('<!DOCTYPE html><div id=\"a\"></div>')\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.findById('a');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\treturn session.execute(\n\t\t\t\t\t\t\t\tfunction(element: Element) {\n\t\t\t\t\t\t\t\t\treturn element.getAttribute('id');\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t[element]\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(attribute) {\n\t\t\t\t\t\t\treturn attribute !== 'a';\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// At least Selendroid 0.16.0 incorrectly returns `undefined`\n\t\t\t// instead of `null` when an undefined value is returned by an\n\t\t\t// `execute` call\n\t\t\tif (capabilities.brokenExecuteUndefinedReturn == null) {\n\t\t\t\ttestedCapabilities.brokenExecuteUndefinedReturn = session\n\t\t\t\t\t.execute('return undefined;')\n\t\t\t\t\t.then(function(value) {\n\t\t\t\t\t\treturn value !== null;\n\t\t\t\t\t}, broken);\n\t\t\t}\n\n\t\t\t// At least Selendroid 0.9.0 always returns invalid element handles\n\t\t\t// from JavaScript\n\t\t\tif (capabilities.brokenExecuteElementReturn == null) {\n\t\t\t\ttestedCapabilities.brokenExecuteElementReturn = function() {\n\t\t\t\t\treturn get('<!DOCTYPE html><div id=\"a\"></div>')\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.execute<Element>(\n\t\t\t\t\t\t\t\t'return document.getElementById(\"a\");'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(element => element && element.getTagName())\n\t\t\t\t\t\t.then(works, broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// At least Selendroid 0.9.0 treats fully transparent elements as\n\t\t\t// displayed, but all others do not\n\t\t\tif (capabilities.brokenElementDisplayedOpacity == null) {\n\t\t\t\ttestedCapabilities.brokenElementDisplayedOpacity = function() {\n\t\t\t\t\treturn get(\n\t\t\t\t\t\t'<!DOCTYPE html><div id=\"a\" style=\"opacity: .1;\">a</div>'\n\t\t\t\t\t)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t// IE<9 do not support CSS opacity so should not be\n\t\t\t\t\t\t\t// involved in this test\n\t\t\t\t\t\t\treturn session.execute(\n\t\t\t\t\t\t\t\t'var o = document.getElementById(\"a\").style.opacity; return o && o.charAt(0) === \"0\";'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(supportsOpacity) {\n\t\t\t\t\t\t\tif (!supportsOpacity) {\n\t\t\t\t\t\t\t\treturn works();\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\treturn session\n\t\t\t\t\t\t\t\t\t.execute(\n\t\t\t\t\t\t\t\t\t\t'document.getElementById(\"a\").style.opacity = \"0\";'\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\t\t\treturn session.findById('a');\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\t\t\t\treturn element.isDisplayed();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// At least ChromeDriver 2.9 treats elements that are offscreen as\n\t\t\t// displayed, but others do not\n\t\t\tif (capabilities.brokenElementDisplayedOffscreen == null) {\n\t\t\t\ttestedCapabilities.brokenElementDisplayedOffscreen = function() {\n\t\t\t\t\tconst pageText =\n\t\t\t\t\t\t'<!DOCTYPE html><div id=\"a\" style=\"left: 0; position: absolute; top: -1000px;\">a</div>';\n\t\t\t\t\treturn get(pageText)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.findById('a');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\treturn element.isDisplayed();\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// The feature test for this causes some browsers to hang, so it's\n\t\t\t// just flagged directly for Edge for now.\n\t\t\t// testedCapabilities.brokenFileSendKeys = function () {\n\t\t\t// \treturn get('<!DOCTYPE html><input type=\"file\" id=\"i1\">').then(function () {\n\t\t\t// \t\tvar element;\n\t\t\t// \t\treturn session.findById('i1')\n\t\t\t// \t\t\t.then(function (element) {\n\t\t\t// \t\t\t\treturn element.type('./Server.js');\n\t\t\t// \t\t\t}).then(function () {\n\t\t\t// \t\t\t\treturn session.execute(function () {\n\t\t\t// \t\t\t\t\treturn document.getElementById('i1').value;\n\t\t\t// \t\t\t\t});\n\t\t\t// \t\t\t}).then(function (text) {\n\t\t\t// \t\t\t\tif (!/Server.js$/.test(text)) {\n\t\t\t// \t\t\t\t\tthrow new Error('mismatch');\n\t\t\t// \t\t\t\t}\n\t\t\t// \t\t\t});\n\t\t\t// \t}).then(works, broken);\n\t\t\t// };\n\n\t\t\t// At least MS Edge Driver 14316 doesn't normalize whitespace\n\t\t\t// properly when retrieving text. Text may contain \"\\r\\n\" pairs\n\t\t\t// rather than \"\\n\", and there may be extraneous whitespace\n\t\t\t// adjacent to \"\\r\\n\" pairs and at the start and end of the text.\n\t\t\tif (capabilities.brokenWhitespaceNormalization == null) {\n\t\t\t\ttestedCapabilities.brokenWhitespaceNormalization = function() {\n\t\t\t\t\treturn get(\n\t\t\t\t\t\t'<!DOCTYPE html><div id=\"d\">This is\\n<br>a test\\n</div>'\n\t\t\t\t\t)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session\n\t\t\t\t\t\t\t\t.findById('d')\n\t\t\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\t\t\treturn element.getVisibleText();\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(function(text) {\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\t/\\r\\n/.test(text) ||\n\t\t\t\t\t\t\t\t\t\t/\\s+$/.test(text)\n\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\tthrow new Error('invalid whitespace');\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(works, broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// At least geckodriver 0.15.0 and Firefox 51.0.1 don't properly\n\t\t\t// normalize link text when using the 'link text' locator strategy.\n\t\t\tif (capabilities.brokenLinkTextLocator == null) {\n\t\t\t\ttestedCapabilities.brokenLinkTextLocator = function() {\n\t\t\t\t\treturn get(\n\t\t\t\t\t\t'<!DOCTYPE html><a id=\"d\">What a cute<span style=\"display:none\">, yellow</span> backpack</a><a id=\"e\">What a cute, yellow backpack</a>'\n\t\t\t\t\t)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session\n\t\t\t\t\t\t\t\t.findByLinkText('What a cute, yellow backpack')\n\t\t\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\t\t\treturn element.getVisibleText();\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(function(text) {\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\ttext !== 'What a cute, yellow backpack'\n\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t\t\t\t\t'incorrect link was found'\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(works, broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// At least MS Edge Driver 14316 doesn't return elements' computed\n\t\t\t// styles\n\t\t\tif (capabilities.brokenComputedStyles == null) {\n\t\t\t\ttestedCapabilities.brokenComputedStyles = function() {\n\t\t\t\t\tconst pageText =\n\t\t\t\t\t\t'<!DOCTYPE html><style>a { background: purple }</style><a id=\"a1\">foo</a>';\n\t\t\t\t\treturn get(pageText)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.findById('a1');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\treturn element.getComputedStyle('background-color');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(value) {\n\t\t\t\t\t\t\tif (!value) {\n\t\t\t\t\t\t\t\tthrow new Error('empty style');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(works, broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (capabilities.brokenOptionSelect == null) {\n\t\t\t\tif (capabilities.brokenOptionSelect == null) {\n\t\t\t\t\t// At least MS Edge Driver 14316 doesn't allow selection\n\t\t\t\t\t// option elements to be clicked.\n\t\t\t\t\ttestedCapabilities.brokenOptionSelect = function() {\n\t\t\t\t\t\treturn get(\n\t\t\t\t\t\t\t'<!DOCTYPE html><select id=\"d\"><option id=\"o1\" value=\"foo\">foo</option>' +\n\t\t\t\t\t\t\t\t'<option id=\"o2\" value=\"bar\" selected>bar</option></select>'\n\t\t\t\t\t\t)\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session.findById('d');\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\t\treturn element.click();\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session.findById('o1');\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\t\treturn element.click();\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(works, broken);\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// At least MS Edge driver 10240 doesn't support getting the page\n\t\t\t// source\n\t\t\tif (capabilities.brokenPageSource == null) {\n\t\t\t\ttestedCapabilities.brokenPageSource = session\n\t\t\t\t\t.getPageSource()\n\t\t\t\t\t.then(works, broken);\n\t\t\t}\n\n\t\t\tif (capabilities.brokenSubmitElement == null) {\n\t\t\t\t// There is inconsistency across all drivers as to whether or\n\t\t\t\t// not submitting a form button should cause the form button to\n\t\t\t\t// be submitted along with the rest of the form; it seems most\n\t\t\t\t// likely that tests do want the specified button to act as\n\t\t\t\t// though someone clicked it when it is submitted, so the\n\t\t\t\t// behaviour needs to be normalised\n\t\t\t\ttestedCapabilities.brokenSubmitElement = function() {\n\t\t\t\t\treturn get(\n\t\t\t\t\t\t'<!DOCTYPE html><form method=\"get\" action=\"about:blank\">' +\n\t\t\t\t\t\t\t'<input id=\"a\" type=\"submit\" name=\"a\" value=\"a\"></form>'\n\t\t\t\t\t)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.findById('a');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\treturn element.submit();\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.getCurrentUrl();\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(url) {\n\t\t\t\t\t\t\treturn url.indexOf('a=a') === -1;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// At least MS Edge driver 10240 doesn't support window sizing\n\t\t\t// commands\n\t\t\tif (capabilities.brokenWindowSize == null) {\n\t\t\t\ttestedCapabilities.brokenWindowSize = session\n\t\t\t\t\t.getWindowSize()\n\t\t\t\t\t.then(works, broken);\n\t\t\t}\n\n\t\t\t// At least Chrome on Mac doesn't properly maximize. See\n\t\t\t// https://bugs.chromium.org/p/chromedriver/issues/detail?id=985\n\t\t\tif (capabilities.brokenWindowMaximize == null) {\n\t\t\t\ttestedCapabilities.brokenWindowMaximize = function() {\n\t\t\t\t\tlet originalSize: { width: number; height: number };\n\t\t\t\t\treturn session\n\t\t\t\t\t\t.getWindowSize()\n\t\t\t\t\t\t.then(size => {\n\t\t\t\t\t\t\toriginalSize = size;\n\t\t\t\t\t\t\treturn session.setWindowSize(\n\t\t\t\t\t\t\t\tsize.width - 10,\n\t\t\t\t\t\t\t\tsize.height - 10\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(() => session.maximizeWindow())\n\t\t\t\t\t\t.then(() => session.getWindowSize())\n\t\t\t\t\t\t.then(size => {\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\tsize.width > originalSize.width &&\n\t\t\t\t\t\t\t\tsize.height > originalSize.height\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// At least Selendroid 0.9.0 has a bug where it catastrophically\n\t\t\t// fails to retrieve available types; they have tried to hardcode\n\t\t\t// the available log types in this version so we can just return\n\t\t\t// the same hardcoded list ourselves.\n\t\t\t// At least InternetExplorerDriver 2.41.0 also fails to provide log\n\t\t\t// types. Firefox 49+ (via geckodriver) doesn't support retrieving\n\t\t\t// logs or log types, and may hang the session.\n\t\t\tif (capabilities.fixedLogTypes == null) {\n\t\t\t\ttestedCapabilities.fixedLogTypes = session\n\t\t\t\t\t.getAvailableLogTypes()\n\t\t\t\t\t.then(unsupported, function(error: LeadfootError) {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tcapabilities.browserName === 'selendroid' &&\n\t\t\t\t\t\t\terror.response!.text.length === 0\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\treturn ['logcat'];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t});\n\t\t\t}\n\n\t\t\t// At least Microsoft Edge 10240 doesn't support timeout values of\n\t\t\t// 0.\n\t\t\tif (capabilities.brokenZeroTimeout == null) {\n\t\t\t\ttestedCapabilities.brokenZeroTimeout = session\n\t\t\t\t\t.setTimeout('implicit', 0)\n\t\t\t\t\t.then(works, broken);\n\t\t\t}\n\n\t\t\tif (capabilities.brokenWindowSwitch == null) {\n\t\t\t\ttestedCapabilities.brokenWindowSwitch = session\n\t\t\t\t\t.getCurrentWindowHandle()\n\t\t\t\t\t.then(function(handle) {\n\t\t\t\t\t\treturn session.switchToWindow(handle);\n\t\t\t\t\t})\n\t\t\t\t\t.then(works, broken);\n\t\t\t}\n\n\t\t\tif (capabilities.brokenParentFrameSwitch == null) {\n\t\t\t\ttestedCapabilities.brokenParentFrameSwitch = session\n\t\t\t\t\t.switchToParentFrame()\n\t\t\t\t\t.then(works, broken);\n\t\t\t}\n\n\t\t\t// This URL is used by several tests below\n\t\t\tconst scrollTestUrl =\n\t\t\t\t'<!DOCTYPE html><div id=\"a\" style=\"margin: 3000px;\"></div>';\n\n\t\t\t// ios-driver 0.6.6-SNAPSHOT April 2014 calculates position based\n\t\t\t// on a bogus origin and does not account for scrolling\n\t\t\tif (capabilities.brokenElementPosition == null) {\n\t\t\t\ttestedCapabilities.brokenElementPosition = function() {\n\t\t\t\t\treturn get(scrollTestUrl)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.findById('a');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\treturn element.getPosition();\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(position) {\n\t\t\t\t\t\t\treturn position.x !== 3000 || position.y !== 3000;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// At least ios-driver 0.6.6-SNAPSHOT April 2014 will never\n\t\t\t// complete a refresh call\n\t\t\tif (capabilities.brokenRefresh == null) {\n\t\t\t\ttestedCapabilities.brokenRefresh = function() {\n\t\t\t\t\treturn session\n\t\t\t\t\t\t.get('about:blank?1')\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\tlet timer: NodeJS.Timer;\n\t\t\t\t\t\t\tlet refresh: Task<boolean | void>;\n\n\t\t\t\t\t\t\treturn new Task(\n\t\t\t\t\t\t\t\tresolve => {\n\t\t\t\t\t\t\t\t\tlet settled = false;\n\n\t\t\t\t\t\t\t\t\trefresh = session\n\t\t\t\t\t\t\t\t\t\t.refresh()\n\t\t\t\t\t\t\t\t\t\t.then(\n\t\t\t\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsettled = true;\n\t\t\t\t\t\t\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\t\t\t\t\t\t\tresolve(false);\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\t\t\t\tsettled = true;\n\t\t\t\t\t\t\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\t\t\t\t\t\t\tresolve(true);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t.finally(() => {\n\t\t\t\t\t\t\t\t\t\t\tif (!settled) {\n\t\t\t\t\t\t\t\t\t\t\t\tresolve(true);\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\ttimer = setTimeout(function() {\n\t\t\t\t\t\t\t\t\t\trefresh.cancel();\n\t\t\t\t\t\t\t\t\t}, 2000);\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\t\t\t\trefresh.cancel();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tcapabilities.brokenMouseEvents == null &&\n\t\t\t\tcapabilities.mouseEnabled\n\t\t\t) {\n\t\t\t\t// At least IE 10 and 11 on SauceLabs don't fire native mouse\n\t\t\t\t// events consistently even though they support moveMouseTo\n\t\t\t\ttestedCapabilities.brokenMouseEvents = function() {\n\t\t\t\t\treturn get(\n\t\t\t\t\t\t'<!DOCTYPE html><div id=\"foo\">foo</div>' +\n\t\t\t\t\t\t\t'<script>window.counter = 0; var d = document; d.onmousemove = function () { window.counter++; };</script>'\n\t\t\t\t\t)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.findById('foo');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\treturn session.moveMouseTo(element, 20, 20);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn sleep(100);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session.execute('return window.counter;');\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(function(counter) {\n\t\t\t\t\t\t\treturn counter > 0 ? works() : broken();\n\t\t\t\t\t\t}, broken);\n\t\t\t\t};\n\n\t\t\t\t// At least ChromeDriver 2.12 through 2.19 will throw an error\n\t\t\t\t// if mouse movement relative to the <html> element is\n\t\t\t\t// attempted\n\t\t\t\tif (capabilities.brokenHtmlMouseMove == null) {\n\t\t\t\t\ttestedCapabilities.brokenHtmlMouseMove = function() {\n\t\t\t\t\t\treturn get('<!DOCTYPE html><html></html>')\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session\n\t\t\t\t\t\t\t\t\t.findByTagName('html')\n\t\t\t\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\t\t\t\treturn session.moveMouseTo(\n\t\t\t\t\t\t\t\t\t\t\telement,\n\t\t\t\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t\t\t\t0\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(works, broken);\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// At least ChromeDriver 2.9.248307 does not correctly emit the\n\t\t\t\t// entire sequence of events that would normally occur during a\n\t\t\t\t// double-click\n\t\t\t\tif (capabilities.brokenDoubleClick == null) {\n\t\t\t\t\ttestedCapabilities.brokenDoubleClick = function retry(): Task<\n\t\t\t\t\t\tany\n\t\t\t\t\t> {\n\t\t\t\t\t\t// InternetExplorerDriver is not buggy, but IE9 in\n\t\t\t\t\t\t// quirks-mode is; since we cannot do feature tests in\n\t\t\t\t\t\t// standards-mode in IE<10, force the value to false\n\t\t\t\t\t\t// since it is not broken in this browser\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tcapabilities.browserName === 'internet explorer' &&\n\t\t\t\t\t\t\tcapabilities.browserVersion === '9'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\treturn Task.resolve(false);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn get(\n\t\t\t\t\t\t\t'<!DOCTYPE html><script>window.counter = 0; var d = document; d.onclick = d.onmousedown = d.onmouseup = function () { window.counter++; };</script>'\n\t\t\t\t\t\t)\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session.findByTagName('html');\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\t\treturn session.moveMouseTo(element);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn sleep(100);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session.doubleClick();\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session.execute(\n\t\t\t\t\t\t\t\t\t'return window.counter;'\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function(counter) {\n\t\t\t\t\t\t\t\t// InternetExplorerDriver 2.41.0 has a race\n\t\t\t\t\t\t\t\t// condition that makes this test sometimes\n\t\t\t\t\t\t\t\t// fail\n\t\t\t\t\t\t\t\t/* istanbul ignore if: inconsistent race condition */\n\t\t\t\t\t\t\t\tif (counter === 0) {\n\t\t\t\t\t\t\t\t\treturn retry();\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn counter !== 6;\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch(broken);\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (capabilities.touchEnabled) {\n\t\t\t\t// At least Selendroid 0.9.0 fails to perform a long tap due to\n\t\t\t\t// an INJECT_EVENTS permission failure\n\t\t\t\tif (capabilities.brokenLongTap == null) {\n\t\t\t\t\ttestedCapabilities.brokenLongTap = session\n\t\t\t\t\t\t.findByTagName('body')\n\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\treturn session.longTap(element);\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(works, broken);\n\t\t\t\t}\n\n\t\t\t\t// At least ios-driver 0.6.6-SNAPSHOT April 2014 claims to\n\t\t\t\t// support touch press/move/release but actually fails when you\n\t\t\t\t// try to use the commands\n\t\t\t\tif (capabilities.brokenMoveFinger == null) {\n\t\t\t\t\ttestedCapabilities.brokenMoveFinger = session\n\t\t\t\t\t\t.pressFinger(0, 0)\n\t\t\t\t\t\t.then(works, function(error) {\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\terror.name === 'UnknownCommand' ||\n\t\t\t\t\t\t\t\terror.message.indexOf(\n\t\t\t\t\t\t\t\t\t'need to specify the JS'\n\t\t\t\t\t\t\t\t) > -1\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Touch scroll in ios-driver 0.6.6-SNAPSHOT is broken, does\n\t\t\t\t// not scroll at all; in selendroid 0.9.0 it ignores the\n\t\t\t\t// element argument\n\t\t\t\tif (capabilities.brokenTouchScroll == null) {\n\t\t\t\t\ttestedCapabilities.brokenTouchScroll = function() {\n\t\t\t\t\t\treturn get(scrollTestUrl)\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session.touchScroll(0, 20);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session.execute(\n\t\t\t\t\t\t\t\t\t'return window.scrollY !== 20;'\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function(isBroken) {\n\t\t\t\t\t\t\t\tif (isBroken) {\n\t\t\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn session\n\t\t\t\t\t\t\t\t\t.findById('a')\n\t\t\t\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\t\t\t\treturn session.touchScroll(\n\t\t\t\t\t\t\t\t\t\t\telement,\n\t\t\t\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t\t\t\t0\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\t\t\treturn session.execute(\n\t\t\t\t\t\t\t\t\t\t\t'return window.scrollY !== 3000;'\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch(broken);\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\t// Touch flick in ios-driver 0.6.6-SNAPSHOT is broken, does not\n\t\t\t\t// scroll at all except in very broken ways if very tiny speeds\n\t\t\t\t// are provided and the flick goes in the wrong direction\n\t\t\t\tif (capabilities.brokenFlickFinger == null) {\n\t\t\t\t\ttestedCapabilities.brokenFlickFinger = function() {\n\t\t\t\t\t\treturn get(scrollTestUrl)\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session.flickFinger(0, 400);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\t\treturn session.execute(\n\t\t\t\t\t\t\t\t\t'return window.scrollY === 0;'\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch(broken);\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tcapabilities.supportsCssTransforms &&\n\t\t\t\tcapabilities.brokenCssTransformedSize == null\n\t\t\t) {\n\t\t\t\ttestedCapabilities.brokenCssTransformedSize = function() {\n\t\t\t\t\treturn get(\n\t\t\t\t\t\t'<!DOCTYPE html><style>#a{width:8px;height:8px;-ms-transform:scale(0.5);-moz-transform:scale(0.5);-webkit-transform:scale(0.5);transform:scale(0.5);}</style><div id=\"a\"></div>'\n\t\t\t\t\t)\n\t\t\t\t\t\t.then(function() {\n\t\t\t\t\t\t\treturn session\n\t\t\t\t\t\t\t\t.execute<Element>(\n\t\t\t\t\t\t\t\t\t'return document.getElementById(\"a\");'\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t.then(function(element) {\n\t\t\t\t\t\t\t\t\treturn element.getSize();\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(function(dimensions) {\n\t\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t\tdimensions.width !== 4 ||\n\t\t\t\t\t\t\t\t\t\tdimensions.height !== 4\n\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(broken);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn Task.all(\n\t\t\t\tObject.keys(testedCapabilities).map(\n\t\t\t\t\tkey => testedCapabilities[key]\n\t\t\t\t)\n\t\t\t).then(() => testedCapabilities);\n\t\t};\n\n\t\tif (capabilities._filled) {\n\t\t\treturn Task.resolve(session);\n\t\t}\n\n\t\t// At least geckodriver 0.11 and Firefox 49+ may hang when getting\n\t\t// 'about:blank' in the first request\n\t\tconst promise: Task<Session | void> = isFirefox(\n\t\t\tcapabilities,\n\t\t\t49,\n\t\t\tInfinity\n\t\t)\n\t\t\t? Task.resolve(session)\n\t\t\t: session.get('about:blank');\n\n\t\treturn promise\n\t\t\t.then(discoverServerFeatures)\n\t\t\t.then(addCapabilities)\n\t\t\t.then(discoverFeatures)\n\t\t\t.then(addCapabilities)\n\t\t\t.then(() => session.get('about:blank'))\n\t\t\t.then(discoverDefects)\n\t\t\t.then(addCapabilities)\n\t\t\t.then(() => session.get('about:blank'))\n\t\t\t.then(() => session);\n\t}\n\n\t/**\n\t * Gets a list of all currently active remote control sessions on this\n\t * server.\n\t */\n\tgetSessions(): Task<Session[]> {\n\t\treturn this.get('sessions').then(function(sessions: any) {\n\t\t\t// At least BrowserStack is now returning an array for the sessions\n\t\t\t// response\n\t\t\tif (sessions && !Array.isArray(sessions)) {\n\t\t\t\tsessions = returnValue(sessions);\n\t\t\t}\n\n\t\t\t// At least ChromeDriver 2.19 uses the wrong keys\n\t\t\t// https://code.google.com/p/chromedriver/issues/detail?id=1229\n\t\t\tsessions.forEach(function(session: any) {\n\t\t\t\tif (session.sessionId && !session.id) {\n\t\t\t\t\tsession.id = session.sessionId;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn sessions;\n\t\t});\n\t}\n\n\t/**\n\t * Gets information on the capabilities of a given session from the server.\n\t * The list of capabilities returned by this command will not include any\n\t * of the extra session capabilities detected by Leadfoot and may be\n\t * inaccurate.\n\t */\n\tgetSessionCapabilities(sessionId: string): Task<Capabilities> {\n\t\treturn this.get('session/$0', undefined, [sessionId]).then(returnValue);\n\t}\n\n\t/**\n\t * Terminates a session on the server.\n\t */\n\tdeleteSession(sessionId: string) {\n\t\treturn this.delete<void>('session/$0', undefined, [sessionId]).then(\n\t\t\tnoop\n\t\t);\n\t}\n}\n\nexport type Method = 'post' | 'get' | 'delete';\n\nfunction isMac(capabilities: Capabilities) {\n\treturn (\n\t\tcapabilities.platform === 'MAC' && capabilities.platformName !== 'ios'\n\t);\n}\n\nfunction isMsEdge(\n\tcapabilities: Capabilities,\n\tminOrExactVersion?: number,\n\tmaxVersion?: number\n) {\n\tif (capabilities.browserName !== 'MicrosoftEdge') {\n\t\treturn false;\n\t}\n\n\treturn isValidVersion(capabilities, minOrExactVersion, maxVersion);\n}\n\nfunction isInternetExplorer(\n\tcapabilities: Capabilities,\n\tminOrExactVersion?: number,\n\tmaxVersion?: number\n) {\n\tif (capabilities.browserName !== 'internet explorer') {\n\t\treturn false;\n\t}\n\n\treturn isValidVersion(capabilities, minOrExactVersion, maxVersion);\n}\n\nfunction isSafari(\n\tcapabilities: Capabilities,\n\tminOrExactVersion?: number,\n\tmaxVersion?: number\n) {\n\tif (capabilities.browserName !== 'safari') {\n\t\treturn false;\n\t}\n\n\treturn isValidVersion(capabilities, minOrExactVersion, maxVersion);\n}\n\nfunction isFirefox(\n\tcapabilities: Capabilities,\n\tminOrExactVersion?: number,\n\tmaxVersion?: number\n) {\n\tif (capabilities.browserName !== 'firefox') {\n\t\treturn false;\n\t}\n\n\treturn isValidVersion(capabilities, minOrExactVersion, maxVersion);\n}\n\n/**\n * Check if a browserVersion is between a min (inclusive) and a max\n * (exclusive). If only one version is specified, it is treated as an exact\n * match.\n */\nfunction isValidVersion(\n\tcapabilities: Capabilities,\n\tminOrExactVersion?: number,\n\tmaxVersion?: number\n) {\n\tif (minOrExactVersion != null) {\n\t\tconst version = parseFloat(\n\t\t\t(capabilities.version || capabilities.browserVersion)!\n\t\t);\n\n\t\tif (maxVersion != null) {\n\t\t\tif (version < minOrExactVersion) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (version >= maxVersion) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else if (version !== minOrExactVersion) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\nfunction noop() {}\n\n/**\n * Returns the actual response value from the remote environment.\n *\n * @param response JsonWireProtocol response object.\n * @returns The actual response value.\n */\nfunction returnValue(response: any): any {\n\treturn response.value;\n}\n\ninterface ResponseData {\n\tresponse: ResponseInterface;\n\tdata: any;\n}\n"]}