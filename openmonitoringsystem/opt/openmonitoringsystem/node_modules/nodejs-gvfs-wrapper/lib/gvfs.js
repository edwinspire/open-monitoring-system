"use strict";
const execFile = require('child_process').execFile;
const spawn = require('child_process').spawn;
const fs = require('fs');
var EventEmitter   = require('events').EventEmitter;
//var extend = require('extend');

var Gvfs = EventEmitter;
Gvfs.prototype.parameters = {domain: '', user: '', password: '', resource: '', protocol: 'smb'};

Gvfs.prototype._build_string = function(){
  var string_return = "";

  string_return = this.parameters.protocol+'://';
  string_return = string_return+this.parameters.domain+'\;';
  string_return = string_return+this.parameters.user+'@';
  string_return = string_return+this.parameters.resource;

/*
  if(_args.protocol && _args.protocol.length > 0){
    string_return = _args.protocol+'://';
  }else{
    string_return = this.parameters.protocol+'://';
  }

  if(_args.domain && _args.domain.length > 0){
    string_return = string_return+_args.domain+'\;';
  }else{
    string_return = string_return+this.parameters.domain+'\;';
  }

  if(_args.user && _args.user.length > 0){
    string_return = string_return+_args.user+'@';
  }else{
    string_return = string_return+this.parameters.user+'@';
  }

  if(_args.resource && _args.resource.length > 0){
    string_return = string_return+_args.resource;
  }else{
    string_return = string_return+this.parameters.resource;
  }
  */
  console.log(string_return);
  return string_return;
};

Gvfs.prototype.mount = function (_param) {
  var t = this;
  var args = [];

  if(_param){
    this.parameters = _param;
  }

  args.push(this._build_string());
  var i = 1;

  const child = spawn('gvfs-mount', args);
  child.on('close', (code, signal) => {
    console.log(
      `child process terminated due to receipt of signal ${signal}`);
  });

  child.on('exit', (code, signal) => {

    switch(code){
      case 0:
      t.emit('mounted', {});
      break;
      case 2:
      t.emit('fail_mount', {message: 'Ya se encuentra montado'});
      break;
    }

    console.log(
      `child process exit ${code}`,  code, signal);
  });

  child.on('error', (error) => {
    console.log(
      `child process error ${error}`);
  });


  child.on('message', (message) => {
    console.log(
      `child process message due to receipt of message ${message}`);
  });

  child.stdout.on('data', (message) => {
    console.log(message+'');

    if((new RegExp('Password:')).test(message)){
      console.log(t.parameters.password);
      if(i < 3){
        child.stdin.write(t.parameters.password);
        child.stdin.write('\n');
      }else{
        child.kill();
        t.emit('fail_mount', {message: 'La contraseÃ±a no es correcta', error: -1});
      }
    }
    
    i++;
  });

  child.stderr.on('data', function (data) {
    console.log('stderr: ' + data);
  });


}

Gvfs.prototype.info = function (_param) {

  var t = this;
  var args = [];

  if(_param){
    this.parameters = _param;
  }

  args.push(this._build_string());
  var i = 1;

  const child = spawn('gvfs-info', args);
  child.on('close', (code, signal) => {
    console.log(
      `child process terminated due to receipt of signal ${signal}`);
  });

  child.on('exit', (code, signal) => {

    switch(code){
      case 0:
      t.emit('info', {});
      break;
      case 2:
      t.emit('fail_mount', {message: 'xxxxxxxxYa se encuentra montado'});
      break;
    }

    console.log(
      `child process exit ${code}`,  code, signal);
  });

  child.on('error', (error) => {
    console.log(
      `child process error ${error}`);
  });


  child.on('message', (message) => {
    console.log(
      `child process message due to receipt of message ${message}`);
  });

  child.stdout.on('data', (message) => {
    console.log('>>>>> '+message+'');
var R = {};
var last_obj_root_child = "";
var msg = message+'';

(msg).split('\n').forEach(function(item, i, m){
  console.log(item);

if((new RegExp('::')).test(item)){

  var a = item.split('::');
 // console.log('"'+a[0]+'":"'+a[1]+'",');

  if(m[i+1]){
var b = item.split(':');
if(b[0] == a[0]){

R[last_obj_root_child][a[0]] = {};

}

  }


}else if((new RegExp(':')).test(item)){
  var a = item.split(':');

  if(m[i+1]){

    if(m[i+1].startsWith('  ')){
   //   console.log('"'+a[0]+'":');
      last_obj_root_child = a[0];
      R[last_obj_root_child] = {};
    }else{
     // console.log('"'+a[0]+'":"'+a[1]+'",');
      R[a[0]] = a[1];
    }

  }else{
   // console.log('"'+a[0]+'":"'+a[1]+'",');
  }

}





});


//console.log(R);  

});

  child.stderr.on('data', function (data) {
    console.log('stderr: ' + data);
  });



}


module.exports = Gvfs;